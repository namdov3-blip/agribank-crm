
import React, { useState, useMemo } from 'react';
import { GlassCard } from '../components/GlassCard';
import { 
  BankTransaction, 
  BankTransactionType, 
  BankAccount, 
  User, 
  Transaction,
  Project,
  TransactionStatus,
  AuditLogItem
} from '../types';
import { formatCurrency, formatDate, formatDateTime, calculateInterest, formatNumberWithComma, parseNumberFromComma } from '../utils/helpers';
import { 
  Wallet, Plus, History, AlertCircle, PiggyBank, X 
} from 'lucide-react';

interface BankBalanceProps {
  transactions: Transaction[];
  projects: Project[];
  bankAccount: BankAccount;
  bankTransactions: BankTransaction[];
  interestRate: number;
  currentUser: User;
  onAddBankTransaction: (type: BankTransactionType, amount: number, note: string, date: string) => void;
  onAdjustOpeningBalance: (amount: number) => void;
  setAuditLogs: React.Dispatch<React.SetStateAction<AuditLogItem[]>>;
}

export const BankBalance: React.FC<BankBalanceProps> = ({ 
  transactions,
  projects,
  bankAccount, 
  bankTransactions, 
  interestRate, 
  onAddBankTransaction,
  currentUser,
  setAuditLogs,
}) => {
  const [isTxModalOpen, setIsTxModalOpen] = useState(false);

  const [txAmount, setTxAmount] = useState('');
  const [txNote, setTxNote] = useState('');
  const [txType, setTxType] = useState<BankTransactionType>(BankTransactionType.DEPOSIT);

  // --- TÍNH TỔNG GỐC, LÃI TẠM TÍNH & TIỀN BỔ SUNG ---
  // Tính từ các giao dịch CHƯA giải ngân (PENDING + HOLD) để khớp với "Tiền chưa GN"
  // Khi giải ngân, các giá trị này sẽ tự động giảm đi
  const pendingData = useMemo(() => {
    if (transactions.length === 0) return { principal: 0, interest: 0, supplementary: 0, locked: 0 };

    let principal = 0; // Tổng gốc của các giao dịch chưa giải ngân
    let tempInterest = 0; // Lãi tạm tính (chưa giải ngân)
    let lockedInterest = 0; // Lãi đã chốt (đã giải ngân)
    let supplementaryAmount = 0; // Tổng tiền bổ sung từ các giao dịch chưa giải ngân

    transactions.forEach(t => {
      if (!t.compensation?.totalApproved) return;
      const project = projects.find(p => p.id === t.projectId);
      const baseDate = t.effectiveInterestDate || project?.interestStartDate;

      if (t.status === TransactionStatus.DISBURSED && t.disbursementDate) {
        // Lãi đã chốt (không còn trong lãi tạm tính)
        lockedInterest += calculateInterest(t.compensation.totalApproved, interestRate, baseDate, new Date(t.disbursementDate));
      } else if (t.status !== TransactionStatus.DISBURSED) {
        // Tổng gốc của các giao dịch chưa giải ngân
        principal += t.compensation.totalApproved;
        // Lãi tạm tính (chỉ từ các giao dịch chưa giải ngân)
        tempInterest += calculateInterest(t.compensation.totalApproved, interestRate, baseDate, new Date());
        // Tiền bổ sung từ các giao dịch chưa giải ngân
        supplementaryAmount += t.supplementaryAmount || 0;
      }
    });

    return {
      principal,                      // Tổng gốc chưa giải ngân
      interest: Math.round(tempInterest), // Lãi tạm tính (PENDING + HOLD)
      locked: Math.round(lockedInterest), // Lãi đã chốt (đã chi cùng giao dịch)
      supplementary: supplementaryAmount  // Tổng tiền bổ sung chưa giải ngân
    };
  }, [transactions, projects, interestRate]);

  const handleTxSubmit = async () => {
    const amountNum = parseNumberFromComma(txAmount);
    if (isNaN(amountNum) || amountNum <= 0) return alert('Số tiền không hợp lệ');
    
    // Tự động xác định loại giao dịch dựa trên dấu số tiền
    // Nếu số tiền dương (+) → Nạp tiền, nếu số tiền âm (-) → Rút tiền
    const finalType = txType;
    const positiveAmount = amountNum;
    
    // Dùng thời gian thực cho ngày giờ giao dịch
    const transactionDateTime = new Date().toISOString();
    
    try {
      // Call API first
      await onAddBankTransaction(finalType, positiveAmount, txNote, transactionDateTime);
      
      // Only save audit log if API call succeeds
      setAuditLogs(prev => [...prev, {
        id: `audit-${Date.now()}`,
        timestamp: transactionDateTime,
        actor: currentUser.name,
        role: currentUser.role,
        action: finalType === BankTransactionType.DEPOSIT ? 'Nạp tiền' : 'Rút tiền',
        target: 'Giao dịch dòng tiền',
        details: `${finalType === BankTransactionType.DEPOSIT ? 'Nạp' : 'Rút'} ${formatCurrency(positiveAmount)}${txNote ? ` - ${txNote}` : ''}`
      }]);
      
      setIsTxModalOpen(false);
      setTxAmount(''); setTxNote('');
    } catch (error) {
      // Error is already handled in handleAddBankTransaction
      // Don't close modal on error so user can retry
    }
  };

  const handleAmountChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    if (value === '') {
      setTxAmount('');
      return;
    }
    // Chỉ cho phép số dương (không có dấu trừ)
    const cleaned = value.replace(/[^\d,]/g, '');
    const formatted = formatNumberWithComma(cleaned);
    setTxAmount(formatted);
  };

  return (
    <div className="space-y-6 animate-fade-in pb-12">
      <div className="flex justify-between items-end pb-2">
        <div>
          <h2 className="text-2xl font-medium text-black tracking-tight">Số dư tài khoản</h2>
          <p className="text-sm font-medium text-slate-500 mt-1">Đối soát & Theo dõi dòng tiền thực tế</p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <GlassCard className="relative overflow-hidden border-blue-400 bg-blue-50/40">
          <div className="absolute -right-4 -top-4 text-blue-100 opacity-50">
            <Wallet size={120} strokeWidth={0.5} />
          </div>
          <h3 className="text-[11px] font-bold text-blue-700 uppercase tracking-widest mb-1">Số dư hiện tại</h3>
          {/*
            Số dư hiện tại (đã bao gồm lãi) = 
            - Số dư thực tế trong tài khoản (currentBalance) 
            + Lãi tạm tính của hồ sơ CHƯA giải ngân
            + Lãi đã chốt của hồ sơ ĐÃ giải ngân.
            Cách tính này khớp với các box "Tiền đã GN" / "Tiền chưa GN" ở tab Giao dịch.
          */}
          <p className="text-2xl font-bold text-slate-900 tracking-tight">
            {formatCurrency(
              bankAccount.currentBalance +
              pendingData.interest +
              pendingData.locked
            )}
          </p>
          {(pendingData.interest > 0 || pendingData.supplementary > 0) && (
            <div className="flex items-center gap-1.5 mt-2">
              <AlertCircle size={10} className="text-blue-500" />
              <p className="text-[10px] font-medium text-blue-600">
                Đã bao gồm lãi tạm tính: {formatCurrency(pendingData.interest)}
                {pendingData.locked > 0 && ` • Lãi đã chốt: ${formatCurrency(pendingData.locked)}`}
                {pendingData.supplementary > 0 && ` • Tiền bổ sung chưa GN: ${formatCurrency(pendingData.supplementary)}`}
              </p>
            </div>
          )}
        </GlassCard>

        <GlassCard className="relative overflow-hidden border-slate-300">
          <h3 className="text-[11px] font-bold text-slate-600 uppercase tracking-widest mb-1">Số dư đối soát</h3>
          <p className="text-2xl font-bold text-slate-900 tracking-tight">{formatCurrency(bankAccount.reconciledBalance)}</p>
          <div className="flex items-center gap-1.5 mt-2">
            <AlertCircle size={10} className="text-slate-400" />
            <p className="text-[10px] font-medium text-slate-500">Khớp với sao kê ngân hàng</p>
          </div>
        </GlassCard>

        <GlassCard className="relative overflow-hidden border-emerald-300 bg-emerald-50/30">
          <h3 className="text-[11px] font-bold text-emerald-700 uppercase tracking-widest mb-1">Lãi tạm tính</h3>
          <p className="text-2xl font-bold text-emerald-600 tracking-tight">{formatCurrency(pendingData.interest)}</p>
          {pendingData.locked > 0 && (
            <p className="text-[10px] font-medium text-slate-500 mt-1">Đã chốt: {formatCurrency(pendingData.locked)}</p>
          )}
        </GlassCard>
      </div>

      <div className="flex flex-col">
        <GlassCard className="p-0 overflow-hidden border-slate-200 flex flex-col h-[650px]">
          <div className="p-5 border-b border-slate-200 bg-white/50 backdrop-blur-md flex justify-between items-center">
            <h3 className="text-sm font-bold text-slate-800 uppercase tracking-widest flex items-center gap-2">
              <History size={16} /> Lịch sử giao dịch dòng tiền
            </h3>
            <button 
              onClick={() => setIsTxModalOpen(true)}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 transition-all shadow-lg"
            >
              Giao dịch mới
            </button>
          </div>

          <div className="flex-1 overflow-y-auto custom-scrollbar">
            <table className="w-full text-left border-collapse">
              <thead className="text-[10px] text-slate-500 font-bold uppercase sticky top-0 bg-slate-50/90 backdrop-blur-sm z-10 border-b border-slate-200">
                <tr>
                  <th className="p-4">Ngày giao dịch</th>
                  <th className="p-4">Loại</th>
                  <th className="p-4 text-right">Số tiền</th>
                  <th className="p-4 text-right">Số dư thực tế</th>
                  <th className="p-4">Nội dung chi tiết</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {bankTransactions.slice().reverse().map((tx) => (
                  <tr
                    key={tx.id}
                    className={`transition-colors border-l-4 ${
                      tx.note.includes('Tự động')
                        ? 'bg-blue-50/60 border-l-blue-500'
                        : tx.amount >= 0
                          ? 'bg-emerald-50/40 border-l-emerald-500 hover:bg-emerald-50/60'
                          : 'bg-rose-50/40 border-l-rose-500 hover:bg-rose-50/60'
                    }`}
                  >
                    <td className="p-4 text-xs font-bold text-slate-800">
                      {formatDateTime(tx.date)}
                    </td>
                    <td className="p-4">
                      <span className={`px-3 py-1.5 rounded-md text-[11px] font-bold shadow-sm ${
                        tx.amount >= 0
                          ? 'bg-emerald-500 text-white'
                          : 'bg-rose-500 text-white'
                      }`}>
                        {tx.amount >= 0 ? '↑ NẠP TIỀN' : '↓ RÚT TIỀN'}
                      </span>
                    </td>
                    <td className={`p-4 text-right font-bold text-sm ${tx.amount >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                      {tx.amount >= 0 ? '+' : ''}{formatCurrency(tx.amount)}
                    </td>
                    <td className="p-4 text-right font-bold text-slate-900 text-sm">{formatCurrency(tx.runningBalance)}</td>
                    <td className="p-4 text-xs text-slate-600 font-medium" style={{ maxWidth: '300px' }}>
                      <div className="line-clamp-5 whitespace-pre-wrap">{tx.note}</div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </GlassCard>
      </div>

      {isTxModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
          <GlassCard className="w-full max-w-md bg-white p-6 shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-bold">Giao dịch dòng tiền</h3>
              <button onClick={() => setIsTxModalOpen(false)}><X size={20}/></button>
            </div>
            <div className="space-y-4">
              {/* Two buttons for deposit/withdraw */}
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setTxType(BankTransactionType.DEPOSIT)}
                  className={`py-4 rounded-xl font-bold text-sm transition-all ${
                    txType === BankTransactionType.DEPOSIT
                      ? 'bg-emerald-500 text-white shadow-lg scale-105'
                      : 'bg-emerald-50 text-emerald-700 border-2 border-emerald-200 hover:bg-emerald-100'
                  }`}
                >
                  ↑ NẠP TIỀN
                </button>
                <button
                  onClick={() => setTxType(BankTransactionType.WITHDRAW)}
                  className={`py-4 rounded-xl font-bold text-sm transition-all ${
                    txType === BankTransactionType.WITHDRAW
                      ? 'bg-rose-500 text-white shadow-lg scale-105'
                      : 'bg-rose-50 text-rose-700 border-2 border-rose-200 hover:bg-rose-100'
                  }`}
                >
                  ↓ RÚT TIỀN
                </button>
              </div>

              <input
                type="text"
                value={txAmount}
                onChange={handleAmountChange}
                className={`w-full border rounded-lg px-4 py-3 text-lg font-bold ${
                  txType === BankTransactionType.DEPOSIT
                    ? 'bg-emerald-50/50 border-emerald-300 focus:ring-emerald-500'
                    : 'bg-rose-50/50 border-rose-300 focus:ring-rose-500'
                }`}
                placeholder="Nhập số tiền (ví dụ: 1,000,000)..."
                inputMode="numeric"
              />
              <textarea
                value={txNote}
                onChange={e => setTxNote(e.target.value)}
                className="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm h-24"
                placeholder="Nội dung giao dịch..."
              />
              <button
                onClick={handleTxSubmit}
                className={`w-full py-3 rounded-xl font-bold shadow-lg transition-all ${
                  txType === BankTransactionType.DEPOSIT
                    ? 'bg-emerald-600 hover:bg-emerald-700 text-white'
                    : 'bg-rose-600 hover:bg-rose-700 text-white'
                }`}
              >
                Xác nhận {txType === BankTransactionType.DEPOSIT ? 'Nạp tiền' : 'Rút tiền'}
              </button>
            </div>
          </GlassCard>
        </div>
      )}
    </div>
  );
};
