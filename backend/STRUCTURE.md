# ğŸ“ Backend Project Structure

Cáº¥u trÃºc Ä‘áº§y Ä‘á»§ cá»§a backend project.

```
E:\Final-main\backend/
â”‚
â”œâ”€â”€ ğŸ“„ package.json                  # Dependencies vÃ  scripts
â”œâ”€â”€ ğŸ“„ tsconfig.json                 # TypeScript configuration
â”œâ”€â”€ ğŸ“„ .env.example                  # Environment variables template
â”œâ”€â”€ ğŸ“„ .env                          # Environment variables (gitignored)
â”œâ”€â”€ ğŸ“„ .gitignore                    # Git ignore rules
â”œâ”€â”€ ğŸ“„ README.md                     # Full documentation
â”œâ”€â”€ ğŸ“„ QUICKSTART.md                 # Quick start guide
â”œâ”€â”€ ğŸ“„ STRUCTURE.md                  # This file
â”‚
â”œâ”€â”€ ğŸ“ prisma/                       # Prisma ORM files
â”‚   â”œâ”€â”€ ğŸ“„ schema.prisma             # Database schema (11 tables)
â”‚   â”œâ”€â”€ ğŸ“„ seed.ts                   # Seed script (5 organizations)
â”‚   â””â”€â”€ ğŸ“ migrations/               # Database migrations
â”‚       â””â”€â”€ ... (generated)
â”‚
â”œâ”€â”€ ğŸ“ src/                          # Source code
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“„ index.ts                  # Main application entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ types/                    # TypeScript types
â”‚   â”‚   â””â”€â”€ ğŸ“„ index.ts              # Shared types (AuthUser, ApiResponse, etc.)
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ utils/                    # Utility functions
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ interestCalculation.ts  # Interest calculation (CORE LOGIC)
â”‚   â”‚   â””â”€â”€ ğŸ“„ helpers.ts            # General helpers
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ middleware/               # Express middleware
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ auth.ts               # JWT authentication
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ validation.ts         # Zod validation schemas
â”‚   â”‚   â””â”€â”€ ğŸ“„ errorHandler.ts       # Global error handler
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ services/                 # Business logic services
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ excelParser.ts        # Excel file parsing
â”‚   â”‚   â””â”€â”€ ğŸ“„ cronJobs.ts           # Cron jobs (interest capitalization)
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ routes/                   # API routes
â”‚       â”œâ”€â”€ ğŸ“„ auth.ts               # Authentication routes
â”‚       â”œâ”€â”€ ğŸ“„ projects.ts           # Projects CRUD
â”‚       â”œâ”€â”€ ğŸ“„ transactions.ts       # Transactions CRUD + workflow
â”‚       â”œâ”€â”€ ğŸ“„ upload.ts             # Excel upload & import
â”‚       â”œâ”€â”€ ğŸ“„ bank.ts               # Bank account & transactions
â”‚       â”œâ”€â”€ ğŸ“„ users.ts              # User management (Admin only)
â”‚       â””â”€â”€ ğŸ“„ admin.ts              # Admin panel (audit logs, interest rate)
â”‚
â”œâ”€â”€ ğŸ“ uploads/                      # Temporary upload folder
â”‚   â””â”€â”€ .gitkeep                     # Keep folder in git
â”‚
â”œâ”€â”€ ğŸ“ dist/                         # Compiled JavaScript (gitignored)
â”‚   â””â”€â”€ ... (generated by tsc)
â”‚
â””â”€â”€ ğŸ“ node_modules/                 # Dependencies (gitignored)
    â””â”€â”€ ...
```

## ğŸ“Š File Sizes & Lines of Code

| File | Lines | Description |
|------|-------|-------------|
| `prisma/schema.prisma` | ~350 | Database schema (11 tables) |
| `prisma/seed.ts` | ~200 | Seed script |
| `src/index.ts` | ~220 | Main app |
| `src/routes/transactions.ts` | ~400 | Transaction routes (most complex) |
| `src/routes/auth.ts` | ~150 | Auth routes |
| `src/routes/projects.ts` | ~150 | Projects routes |
| `src/routes/upload.ts` | ~120 | Upload routes |
| `src/routes/bank.ts` | ~130 | Bank routes |
| `src/routes/users.ts` | ~120 | Users routes |
| `src/routes/admin.ts` | ~150 | Admin routes |
| `src/middleware/auth.ts` | ~130 | Auth middleware |
| `src/middleware/validation.ts` | ~250 | Validation schemas |
| `src/middleware/errorHandler.ts` | ~120 | Error handler |
| `src/services/excelParser.ts` | ~150 | Excel parser |
| `src/services/cronJobs.ts` | ~180 | Cron jobs |
| `src/utils/interestCalculation.ts` | ~150 | Interest calculation |
| `src/utils/helpers.ts` | ~120 | General helpers |
| `src/types/index.ts` | ~100 | Type definitions |

**Total:** ~3,040 lines of TypeScript code (excluding comments)

## ğŸ”‘ Key Files to Understand

### 1. **prisma/schema.prisma** (Database Schema)
- Defines 11 tables
- Multi-tenancy with `organizationId`
- Enums: TransactionStatus, BankTransactionType, UserRole

### 2. **src/index.ts** (Main App)
- Express server setup
- CORS configuration
- Route mounting
- Cron job initialization
- Graceful shutdown handling

### 3. **src/middleware/auth.ts** (Authentication)
- JWT token verification
- User info extraction from token
- Permission checking
- Admin role validation

### 4. **src/routes/transactions.ts** (Transaction Routes)
- Most complex routes
- Status change logic (PENDING â†’ DISBURSED)
- Refund logic (DISBURSED â†’ HOLD)
- Supplementary amount management
- Bank balance updates

### 5. **src/utils/interestCalculation.ts** (Interest Logic)
- **CRITICAL**: Must match frontend exactly!
- Daily compound interest calculation
- Days counting logic
- Transaction interest calculation

### 6. **src/services/excelParser.ts** (Excel Parsing)
- Real Excel file parsing with `xlsx`
- Data validation
- Row extraction
- Error handling

### 7. **src/services/cronJobs.ts** (Cron Jobs)
- Daily interest check (00:01)
- Monthly interest capitalization (02:00 on 1st)
- Auto-deposit to bank account

## ğŸ“¦ Dependencies Breakdown

### Production Dependencies (17)
```json
{
  "@prisma/client": "^5.22.0",      // ORM
  "bcryptjs": "^2.4.3",             // Password hashing
  "cors": "^2.8.5",                 // CORS middleware
  "dotenv": "^16.4.5",              // Environment variables
  "express": "^4.19.2",             // Web framework
  "jsonwebtoken": "^9.0.2",         // JWT authentication
  "multer": "^1.4.5-lts.1",         // File upload
  "node-cron": "^3.0.3",            // Cron jobs
  "xlsx": "^0.18.5",                // Excel parsing
  "zod": "^3.23.8"                  // Validation
}
```

### Dev Dependencies (9)
```json
{
  "@types/*": "...",                // TypeScript types
  "prisma": "^5.22.0",              // Prisma CLI
  "ts-node": "^10.9.2",             // Run TypeScript
  "ts-node-dev": "^2.0.0",          // Hot reload
  "typescript": "^5.8.2"            // TypeScript compiler
}
```

## ğŸ”„ Data Flow

```
Client (Frontend)
     â†“ HTTP Request (JWT Token)
[Express Server]
     â†“ Middleware: authenticate()
     â†“ Middleware: validate()
[Route Handler]
     â†“ Business Logic
[Prisma Client]
     â†“ SQL Query (filtered by organizationId)
[PostgreSQL Database]
     â†“ Result
[Response Converter] (BigInt â†’ Number)
     â†“ JSON Response
Client (Frontend)
```

## ğŸ¯ Multi-Tenancy Implementation

**Every route automatically filters by organizationId:**

```typescript
// Example: Get projects
const projects = await prisma.project.findMany({
  where: {
    organizationId: req.user!.organizationId  // From JWT token
  }
});
```

**JWT Token Structure:**
```json
{
  "id": "user-uuid",
  "organizationId": "org-uuid",
  "username": "admin_org001",
  "fullName": "Quáº£n trá»‹ viÃªn",
  "role": "Admin",
  "permissions": ["dashboard", "projects", "..."]
}
```

## ğŸ” Security Layers

1. **JWT Authentication**: All routes (except login) require valid token
2. **Organization Isolation**: Queries auto-filter by `organizationId`
3. **Role-based Access**: Admin routes require `requireAdmin` middleware
4. **Input Validation**: Zod schemas validate all request bodies
5. **Password Hashing**: bcrypt with salt rounds = 10
6. **SQL Injection Protection**: Prisma ORM parameterizes queries
7. **CORS**: Only configured frontend URL allowed

## ğŸ§ª Testing Strategy

1. **Unit Tests**: Test individual functions (interest calculation, helpers)
2. **Integration Tests**: Test API endpoints with supertest
3. **E2E Tests**: Test full workflows (upload â†’ import â†’ disbursement)
4. **Manual Tests**: Postman collection or cURL commands

## ğŸ“ˆ Scalability Considerations

- **Current**: Single server, 30 users, 5 organizations
- **Future**: Can scale to 100+ users with proper indexing
- **Database**: PostgreSQL can handle millions of records
- **Caching**: Can add Redis for frequently accessed data
- **Load Balancing**: Can add multiple instances behind Nginx

---

**Last Updated:** 2025-01-13
